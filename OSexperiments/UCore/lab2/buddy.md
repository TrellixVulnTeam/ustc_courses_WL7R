# lab2 Chanllenge1 :Buddy System(伙伴系统)的实现

## 算法

Buddy System将物理内存组织成一个二叉树结构，对于内存分配请求，从根节点开始搜索，找到满足需求的最小的内存块结点并分配，因此每次分配的内存块的大小都是2的整数幂页连续内存空间。当最小的连续内存块大于请求大小的两倍时，将内存块等分后再进行搜索，直到找到一块大小介于请求空间大小的一倍到两倍之间的结点。当内存被释放时，将自底向上搜索是否存在同一父结点的兄弟结点也空闲的情况，有则需要进行内存块的合并，以便之后能够完成对较大内存块的需求。


## 数据结构的组织

由于内存空间被组织为一个二叉树结构，为了维护这个结构并实现高效的查找，需要一定的内存来存储二叉树自身的结点信息。对于32位系统，其最大内存空间为4G，按照一页的大小为4KB来组织，最多有1M页，因此用一个32位整数来记录一个结点的信息便足够。

Buddy System将物理内存组织为了一棵满二叉树，即叶子结点的数量总是2的整数幂。然而能够用来分配的物理空间页数却不总是2的整数幂，此外，维护二叉树的信息页需要消耗至少一页的物理内存。因此，如何将一块完整的内存空间分出信息存储区和实际分配区是一个需要考虑的问题。

特别地，假设Buddy System需要管理2^h个物理页面，即二叉树的叶节点总共有2^h个，则二叉树的结点总数为2^(h+1)-1个，简单起见，这里直接算作2^(h+1)个。而每个结点需要一个4字节整数来记录其可用空间，因此维护二叉树所需要的总的存储空间为2^(h+3)B。一个页面的大小为4KB即2^12B,因此需要的物理页数为2^(h-9)页。内存成页分配，最终消耗的页数为max{1,2^(h-9)}。

如果需要管理的物理页数不大于512页，则拿出其中一页用来维护信息，剩下的页数取不大于它的最大2的整数幂页来构成二叉树。如果需要管理的物理页数大于512页,设为t页，则需要求解不等式 2^(h-9) + 2^h <= t,从而确定组织成多大规模的二叉树。而这样势必会造成一部分物理页既没有用来维护信息，也无法被分配，从而被浪费的情况。为了避免这种情况，可以在当存在物理页冗余的情况下，扩大二叉树的规模，这样即增大了可以被分配的物理页，也需要分配更多的页来维护信息，但一般情况下，这种方式实际获得的能够分配的物理页数是增加的，因为增加一页用来维护信息就最多可以获得512页用来分配。为了尽可能的使所有的物理页都得到利用，对于t>512的情况，直接建立最大规模的二叉树，即其叶结点数不超过t其为最大的2的整数幂，不妨设为2^h，并为这些页面分配维护其信息的页。如果总页数再加倍维护页的情况下仍然有冗余，则使维护页和分配页同时加倍。对于二叉树中无法对应到物理页中的一部分结点，可以视为其已经被分配，且永远不会被释放从，让除维护页以外所有的页面都有可能被分配出去。


## 初始化

首先利用宏定义计算舍入到2的整数幂的方法，其算法可以参考 [这个页面](http://www.codeweblog.com/%E8%AE%A1%E7%AE%97%E5%A4%A7%E4%BA%8E%E6%88%96%E7%AD%89%E4%BA%8E%E6%AD%A3%E6%95%B4%E6%95%B0%E7%9A%842%E7%9A%84%E5%B9%82%E6%AC%A1%E6%96%B9%E6%95%B0/)。代码中所实现的算法主要思想其一致，只是为了在二叉树上查找的方便而稍有取舍。总体的思路是将一个数的从最高非0位到末位全部置1，这个操作可以通过右移和或运算完成。然后通过与运算取出其去掉首位1之后的数字，这便是原来的数模上不大于其自身的最大的2的整数幂的结果。

初始化的工作分为两个部分，一部分是按照算法原理计算出如何分配获得的内存空间用于维护二叉树信息和实际分配。另一部分就是二叉树的建立和初始维护信息的生成。由于二叉树并非所有的结点都能用于实际分配，因此初始时就要根据还能够成块的可分配空间大小对树结点进行分割。如果可分配空间恰好等于根结点对应空间，则初始化根结点即可。否则递归进行以下操作：记录当前结点可分配空间，当前结点可分配空间不小于左子树对应空间，初始化左子树，转右子树，否则将右子树可分配空间置0，转左子树。

## 页面分配

首先将待分配空间转化为不小于其的最小的2的整数幂作为查找吗目标。从根节点开始向下查找，若当前结点空闲空间大于目标且完全空闲，则分裂该结点生成左右子树后转左子树，若不空闲则比较其子树剩余空间是否够分配，够则转入，否则退出搜索。搜索结束处的结点若大于目标大小则分配，否则无法满足分配目标的要求。成功分配后需要自被分配结点起向上更新维护信息。

## 页面释放

可根据被释放的页面的首位地址直接查找到其对应的结点，自该结点向上更新维护信息，并考察其兄弟结点是否空闲，若空闲则合并。

## 测试

运行测试将/lab2/kern/mm/pmm.c的第140行和第141行的注释代码交换即可。buddy.c中给出的测试分配了1026页的实际大小，并仿造default_check()进行了3个页面的分配测试，分配后按照链表的维护次序将剩余空间全部按其块大小分配，并再次进行3个页面的测试。