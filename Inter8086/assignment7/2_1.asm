PORT_DATA EQU 3020H
PORT_MODE EQU 3021H

DATA SEGMENT
	STR1 DB "Self-Communication by 8251!"   
	COUNT EQU $-STR1
DATA ENDS

CODE SEGMENT 
	ASSUME DS:DATA, CS:CODE
START:	MOV AX, DATA
		MOV DS, AX
		CALL INIT
		CALL DELLY
		MOV AL, 01111110B  ;一个停止位， 偶校验， 字符长度位8位， 异步方式x16
		MOV DX, PORT_MODE
		OUT DX, AL  
		CALL DELLY
		MOV AL, 00110100B	;允许接收， 禁止发送
		OUT DX, AL
		CALL DELLY
		MOV CX, COUNT
		MOV SI, OFFSET STR1
A1:		MOV AL, [SI]
		CALL SEND
		CALL DELLY 
		INC SI
		LOOP A1 

A4:		MOV AH, 1
		INT 16H
		JZ A4
		MOV AX, 4C00H
		INT 21H
INIT	PROC
	MOV AL, 00H
	MOV DX, PORT_MODE
	OUT DX, AL 
	CALL DELLY
	OUT DX, AL
	CALL DELLY
	OUT DX, AL
	CALL DELLY
	MOV AL, 40H
	OUT DX, AL
	RET

DELLY	PROC
	PUSH CX
	MOV CX, 0003H
A5:	PUSH AX
	POP AX
	LOOP A5
	POP CX
	RET  
	
SEND	PROC   
	PUSH DX
	PUSH AX   
	MOV AL, 31H
	MOV DX, PORT_MODE
	OUT DX, AL
	POP AX
	MOV DX, PORT_DATA
	OUT DX, AL
	MOV DX, PORT_MODE
A7:	IN AL, DX
	AND AL, 01H
	JZ A7
	POP DX
	RET
	
	
	
CODE ENDS
	END START